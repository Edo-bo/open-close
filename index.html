<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Kontrol & Hapus Pesan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .glass {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .message-item:hover {
            background-color: #f7f7f7;
        }
        /* Custom scrollbar for message list */
        .message-list::-webkit-scrollbar {
            width: 6px;
        }
        .message-list::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 3px;
        }
    </style>
</head>
<body class="bg-slate-900 min-h-screen flex items-center justify-center p-4">

    <!-- Container Utama -->
    <div class="glass w-full max-w-lg p-6 sm:p-8 rounded-2xl shadow-2xl border border-slate-700 relative overflow-hidden my-10">
        
        <!-- Header -->
        <div class="text-center mb-6">
            <div class="inline-flex items-center justify-center w-14 h-14 rounded-full bg-slate-100 mb-3 shadow-inner">
                <i data-lucide="shield-half" class="w-7 h-7 text-slate-700"></i>
            </div>
            <h1 class="text-xl sm:text-2xl font-extrabold text-slate-800">Admin Dashboard</h1>
            <p class="text-slate-500 text-xs sm:text-sm mt-1">Kontrol Chat, Spam Reaksi, & Hapus Pesan</p>
        </div>

        <!-- === BAGIAN 1: KONTROL CHAT (EXISTING) === -->
        <div class="mb-8 border-b border-slate-200 pb-8">
            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 text-center">Status Chat</p>
            
            <!-- Tampilan Status: Loading -->
            <div id="status-loading" class="flex items-center justify-center p-4 bg-slate-100 rounded-xl animate-pulse">
                <span class="text-slate-500 font-medium">Menghubungkan Database...</span>
            </div>

            <!-- Tampilan Status: OPEN -->
            <div id="status-open" class="hidden flex-col items-center justify-center p-4 bg-green-50 border-2 border-green-500 rounded-xl mb-4 transition-all">
                <div class="flex items-center gap-2">
                    <i data-lucide="unlock" class="w-5 h-5 text-green-600"></i>
                    <h2 class="text-lg font-black text-green-700">TERBUKA</h2>
                </div>
                <p class="text-green-600 text-xs mt-1">User BISA kirim pesan</p>
            </div>

            <!-- Tampilan Status: CLOSED -->
            <div id="status-closed" class="hidden flex-col items-center justify-center p-4 bg-red-50 border-2 border-red-500 rounded-xl mb-4 transition-all">
                <div class="flex items-center gap-2">
                    <i data-lucide="lock" class="w-5 h-5 text-red-600"></i>
                    <h2 class="text-lg font-black text-red-700">TERTUTUP</h2>
                </div>
                <p class="text-red-600 text-xs mt-1">User TIDAK BISA kirim pesan</p>
            </div>

            <!-- Tombol Kontrol Chat -->
            <div class="grid grid-cols-2 gap-3">
                <button onclick="updateChatStatus(true)" class="flex items-center justify-center gap-2 p-3 bg-white border border-slate-200 rounded-lg hover:bg-green-50 hover:border-green-300 transition-all active:scale-95 shadow-sm">
                    <i data-lucide="power" class="w-4 h-4 text-green-600"></i>
                    <span class="font-bold text-sm text-slate-700">BUKA</span>
                </button>
                <button onclick="updateChatStatus(false)" class="flex items-center justify-center gap-2 p-3 bg-white border border-slate-200 rounded-lg hover:bg-red-50 hover:border-red-300 transition-all active:scale-95 shadow-sm">
                    <i data-lucide="ban" class="w-4 h-4 text-red-600"></i>
                    <span class="font-bold text-sm text-slate-700">TUTUP</span>
                </button>
            </div>
        </div>

        <!-- === BAGIAN 2: GENERATOR REAKSI (EXISTING) === -->
        <div class="mb-8 border-b border-slate-200 pb-8">
            <div class="flex items-center justify-center gap-2 mb-3">
                <i data-lucide="zap" class="w-4 h-4 text-yellow-500"></i>
                <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Spam Reaksi (Fake User)</p>
            </div>
            
            <p class="text-xs text-center text-slate-500 mb-4 px-4">
                Klik tombol untuk menambahkan 1 angka.
            </p>

            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                <button onclick="addFakeReaction('love')" class="group p-3 bg-white border border-pink-200 rounded-xl hover:bg-pink-50 transition-all active:scale-95 shadow-sm hover:shadow-md flex flex-col items-center">
                    <span class="text-2xl mb-1 group-hover:scale-110 transition">‚ù§Ô∏è</span>
                    <span class="text-xs font-bold text-pink-600">Love</span>
                </button>
                <button onclick="addFakeReaction('birthday')" class="group p-3 bg-white border border-yellow-200 rounded-xl hover:bg-yellow-50 transition-all active:scale-95 shadow-sm hover:shadow-md flex flex-col items-center">
                    <span class="text-2xl mb-1 group-hover:scale-110 transition">ü•≥</span>
                    <span class="text-xs font-bold text-yellow-600">Ultah</span>
                </button>
                <button onclick="addFakeReaction('will_come')" class="group p-3 bg-white border border-blue-200 rounded-xl hover:bg-blue-50 transition-all active:scale-95 shadow-sm hover:shadow-md flex flex-col items-center">
                    <span class="text-2xl mb-1 group-hover:scale-110 transition">ü´Ç</span>
                    <span class="text-xs font-bold text-blue-600">Hadir</span>
                </button>
                <button onclick="addFakeReaction('cannot_come')" class="group p-3 bg-white border border-gray-200 rounded-xl hover:bg-gray-100 transition-all active:scale-95 shadow-sm hover:shadow-md flex flex-col items-center">
                    <span class="text-2xl mb-1 group-hover:scale-110 transition">üôè</span>
                    <span class="text-xs font-bold text-gray-600">Maaf</span>
                </button>
            </div>
        </div>

        <!-- === BAGIAN 3: MANAJEMEN PESAN ULANG TAHUN (UPDATED) === -->
        <div>
            <div class="flex items-center justify-center gap-2 mb-3">
                <i data-lucide="message-square-text" class="w-4 h-4 text-indigo-500"></i>
                <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Manajemen Ucapan Ulang Tahun</p>
            </div>
            
            <!-- Kontrol Pilih Semua & Hapus -->
            <div class="flex justify-between items-center bg-indigo-50 p-3 rounded-t-xl border border-indigo-200">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" id="selectAllCheckbox" class="w-4 h-4 text-indigo-600 bg-white border-indigo-300 rounded focus:ring-indigo-500">
                    <span class="text-sm font-semibold text-indigo-700">Pilih Semua</span>
                </label>
                <button id="deleteSelectedBtn" onclick="deleteSelectedWishes()" class="px-3 py-1 bg-red-500 text-white text-xs font-bold rounded-lg shadow hover:bg-red-600 disabled:bg-red-300 transition-all flex items-center gap-1" disabled>
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                    Hapus Terpilih
                </button>
            </div>

            <!-- Daftar Pesan -->
            <div id="wishes-list" class="message-list bg-white border border-indigo-200 rounded-b-xl max-h-80 overflow-y-auto divide-y divide-slate-100">
                <!-- Pesan akan dimuat di sini oleh JavaScript -->
                <div id="wishes-loading" class="p-4 text-center text-slate-500 text-sm">Memuat pesan...</div>
            </div>
        </div>


        <!-- Footer Info -->
        <div class="mt-8 text-center border-t border-slate-100 pt-4">
            <p class="text-[10px] text-slate-400">
                Connected to: ultah-5a889
            </p>
        </div>
    </div>

    <!-- NOTIFIKASI TOAST -->
    <div id="toast" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl opacity-0 transition-opacity duration-300 pointer-events-none flex items-center gap-2 z-50">
        <i data-lucide="check-circle" class="w-5 h-5 text-green-400"></i>
        <span id="toast-msg">Status diperbarui!</span>
    </div>

    <!-- LOGIC FIREBASE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Konfigurasi Firebase (HARUS SAMA DENGAN APLIKASI UTAMA)
        const firebaseConfig = {
            apiKey: "AIzaSyBRAnZpX83hFpzU0RyMBlesHcFJRrsvpGg",
            authDomain: "ultah-5a889.firebaseapp.com",
            databaseURL: "https://ultah-5a889-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ultah-5a889",
            storageBucket: "ultah-5a889.firebase storage.app",
            messagingSenderId: "707828837954",
            appId: "1:707828837954:web:5c21b4a2c5288c453787db",
            measurementId: "G-YT9V385LNM"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        // Refs
        const configRef = ref(db, 'config/chat_open');
        const wishesRef = ref(db, 'birthday_wishes');

        // --- 1. LOGIC STATUS CHAT (EXISTING) ---
        onValue(configRef, (snapshot) => {
            const isOpen = snapshot.val();
            const elLoading = document.getElementById('status-loading');
            const elOpen = document.getElementById('status-open');
            const elClosed = document.getElementById('status-closed');

            elLoading.classList.add('hidden');

            if (isOpen === true) {
                elOpen.classList.remove('hidden');
                elOpen.classList.add('flex');
                elClosed.classList.add('hidden');
                elClosed.classList.remove('flex');
            } else {
                elClosed.classList.remove('hidden');
                elClosed.classList.add('flex');
                elOpen.classList.add('hidden');
                elOpen.classList.remove('flex');
            }
        });

        window.updateChatStatus = function(status) {
            set(configRef, status)
                .then(() => showToast(status ? "Chat DIBUKA" : "Chat DITUTUP"))
                .catch((error) => console.error("Gagal update chat status: ", error));
        }

        // --- 2. LOGIC FAKE REACTION (EXISTING) ---
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        window.addFakeReaction = function(type) {
            const fakeUserId = generateUUID();
            const reactionRef = ref(db, `zahra_reactions/user_choices/${fakeUserId}`);
            
            set(reactionRef, type)
                .then(() => {
                    let label = "";
                    if(type === 'love') label = "Love ‚ù§Ô∏è";
                    if(type === 'birthday') label = "Ultah ü•≥";
                    if(type === 'will_come') label = "Hadir ü´Ç";
                    if(type === 'cannot_come') label = "Maaf üôè";
                    
                    showToast(`+1 ${label} ditambahkan!`);
                })
                .catch((error) => console.error("Gagal spam reaksi: ", error));
        }

        // --- 3. LOGIC MANAJEMEN PESAN ULTAH (UPDATED) ---
        const wishesList = document.getElementById('wishes-list');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
        let currentWishes = {}; 

        // Handle Checkbox Pilih Semua
        selectAllCheckbox.addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            document.querySelectorAll('.wish-checkbox').forEach(checkbox => {
                checkbox.checked = isChecked;
            });
            updateDeleteButtonState();
        });

        // Update Tombol Hapus Terpilih
        function updateDeleteButtonState() {
            const checkedCount = document.querySelectorAll('.wish-checkbox:checked').length;
            deleteSelectedBtn.disabled = checkedCount === 0;
            deleteSelectedBtn.textContent = checkedCount > 0 ? `Hapus (${checkedCount}) Pesan` : 'Hapus Terpilih';
        }
        
        // Listener Pesan Real-Time
        onValue(wishesRef, (snapshot) => {
            currentWishes = {};
            wishesList.innerHTML = '';
            const data = snapshot.val();
            
            if (!data) {
                wishesList.innerHTML = '<div class="p-4 text-center text-slate-500 text-sm italic">Belum ada ucapan ulang tahun.</div>';
                selectAllCheckbox.disabled = true;
                updateDeleteButtonState();
                return;
            }

            selectAllCheckbox.disabled = false;
            
            const wishesArray = Object.keys(data).map(key => ({
                id: key,
                ...data[key]
            })).reverse(); 

            wishesArray.forEach(wish => {
                currentWishes[wish.id] = wish;
                // Menggunakan wish.name dan wish.text sesuai struktur database Anda
                const senderName = wish.name || 'Anonim';
                const messageText = wish.text || 'Pesan kosong';

                const messageHtml = `
                    <div class="message-item p-3 flex items-start gap-3">
                        <input type="checkbox" data-id="${wish.id}" class="wish-checkbox w-4 h-4 mt-1 text-indigo-600 bg-white border-gray-300 rounded focus:ring-indigo-500" onchange="window.updateDeleteButtonState()">
                        <div class="flex-1 min-w-0">
                            <p class="font-bold text-sm text-slate-800 truncate" title="${senderName}">${senderName}</p>
                            <p class="text-xs text-slate-600 break-words">${messageText}</p>
                            ${wish.timestamp ? `<p class="text-[10px] text-slate-400 mt-1">${new Date(wish.timestamp).toLocaleString()}</p>` : ''}
                        </div>
                    </div>
                `;
                wishesList.innerHTML += messageHtml;
            });
            
            // Tambahkan event listener untuk setiap checkbox baru
            document.querySelectorAll('.wish-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateDeleteButtonState);
            });

            updateDeleteButtonState(); 
        });

        // Fungsi Hapus Pesan Terpilih (DIPERBAIKI: Menghapus confirm() dan menambahkan error logging)
        window.deleteSelectedWishes = async function() {
            const selectedIds = Array.from(document.querySelectorAll('.wish-checkbox:checked'))
                                     .map(checkbox => checkbox.getAttribute('data-id'));

            if (selectedIds.length === 0) {
                showToast("Tidak ada pesan yang dipilih.");
                return;
            }
            
            let successfulDeletes = 0;
            let failedDeletes = 0;
            
            // Visual feedback saat proses berlangsung
            deleteSelectedBtn.disabled = true; 
            deleteSelectedBtn.textContent = 'Menghapus...';
            deleteSelectedBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
            deleteSelectedBtn.classList.add('bg-slate-500');

            for (const id of selectedIds) {
                try {
                    // PENTING: Lakukan penghapusan
                    await remove(ref(db, `birthday_wishes/${id}`));
                    successfulDeletes++;
                } catch (error) {
                    failedDeletes++;
                    // Log error ke konsol untuk debug Security Rules Firebase
                    console.error(`FIREBASE ERROR: Gagal menghapus pesan ID ${id}. Kemungkinan Izin Tulis (Write Permission) ditolak oleh Firebase Security Rules.`, error);
                }
            }

            // Reset UI
            selectAllCheckbox.checked = false;
            deleteSelectedBtn.classList.remove('bg-slate-500');
            deleteSelectedBtn.classList.add('bg-red-500', 'hover:bg-red-600');
            updateDeleteButtonState();
            
            if (failedDeletes === 0) {
                showToast(`${successfulDeletes} pesan berhasil dihapus!`);
            } else {
                showToast(`Selesai. ${successfulDeletes} berhasil, ${failedDeletes} GAGAL (Cek Console)`);
            }
        }
        
        // Export functions to window for onclick calls
        window.updateDeleteButtonState = updateDeleteButtonState;


        // --- UI HELPER: TOAST ---
        function showToast(message) {
            const toast = document.getElementById('toast');
            const msg = document.getElementById('toast-msg');
            msg.innerText = message;
            // Gunakan warna berbeda jika ada kegagalan
            if (message.includes('GAGAL')) {
                toast.classList.remove('bg-slate-800');
                toast.classList.add('bg-red-700');
            } else {
                 toast.classList.remove('bg-red-700');
                 toast.classList.add('bg-slate-800');
            }

            toast.classList.remove('opacity-0');
            toast.classList.add('opacity-100', '-translate-y-2');
            
            setTimeout(() => {
                toast.classList.remove('opacity-100', '-translate-y-2');
                toast.classList.add('opacity-0');
            }, 3000);
        }
    </script>

    <script>
        // Inisialisasi ikon Lucide
        lucide.createIcons();
    </script>
</body>
</html>
